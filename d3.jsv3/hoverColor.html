<html>

<head>
   <title>force layout</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100&display=swap" rel="stylesheet">
   <style id="compiled-css" type="text/css">
      @charset "utf-8";

      /* CSS Document */
      .link10 {
         stroke: rgb(226, 57, 57);
         stroke-width: 2px;
         stroke-dasharray: 3, 3;
      }

      .link1 {
         stroke: #000;
         stroke-width: 1px;
      }

      .nodetext {
         pointer-events: none;
         fill: black;
         font-family: 'Roboto', sans-serif;
      }

      .node.type1 {
         fill: #aa169e;
      }

      .node.type2 {
         fill: #10797c;
      }

      .node.type3 {
         fill: #E5B96F;
      }

      body {
         display: flex;
         flex-direction: row-reverse;
         justify-content: start;
         align-items: center;
      }
   </style>
</head>

<body>
   <img width="150" height="150"></img>
   <button id="btnRestart">Inicio</button>
   <script src="https://d3js.org/d3.v2.js?2.9.1"></script>
   <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
   <script type='text/javascript'>
      var expand = false;
      var expandChild = false;
      var data = {
         "nodes": [
            {
               "name": "Alquiler", "r": 15, "type": 1, "img": "alquiler.png", "parent": true,//0
               "links": [
                  { "source": 0, "target": 1, "value": 1, "distance": 15 },
                  { "source": 0, "target": 2, "value": 1, "distance": 5 },
                  { "source": 0, "target": 3, "value": 1, "distance": 15 },
                  { "source": 0, "target": 4, "value": 1, "distance": 10 },

               ]
            },//12
            { "name": "Oferta", "r": 10, "type": 2, "img": "alquiler.png" },//1
            { "name": "Inversiones", "r": 10, "type": 2, "img": "alquiler.png", "parentChild": true },//2
            {
               "name": "Arrendador", "r": 10, "type": 2, "img": "alquiler.png", "parentChild": true,
               "links": [
                  { "source": 3, "target": 5, "value": 10, "distance": 10 },
                  { "source": 3, "target": 6, "value": 10, "distance": 10 },
               ]
            },//3
            { "name": "Arrendatario", "r": 10, "type": 2 },//4
            { "name": "Sr.x", "r": 10, "type": 2 },//5
            { "name": "Sr.Z", "r": 10, "type": 2 },//6
         ],
         "links": [

         ]
      }
      var w = 560, h = 500,
         radius = d3.scale.log().domain([0, 312000]).range(["10", "50"]);
      var vis = d3.select("body").append("svg:svg")
         .attr("width", w)
         .attr("height", h);

      var force = self.force = d3.layout.force()
         .nodes(data.nodes)
         .links(data.links)
         .linkDistance(function (d) { return (d.distance * 12); })
         .charge(-250)
         .size([w, h])
         .start();

      var link = vis.selectAll("line.link")
         .data(data.links)//data
         .enter().append("svg:line")
         .attr("class", function (d) { return "link" + d.value + ""; })
         .attr("x1", function (d) { return d.source.x; })
         .attr("y1", function (d) { return d.source.y; })
         .attr("x2", function (d) { return d.target.x; })
         .attr("y2", function (d) { return d.target.y; })

      function fade(opacity) {
         link.style("opacity", function (d) {
            return d.source === d || d.target === d ? 1 : opacity;
         });
      }

      var lines = vis.append('g').attr('class', 'lines');
      var nodes = vis.append('g').attr('class', 'nodes');
      var texts = vis.append('g').attr('class', 'texts');

      var node = d3.select(".nodes").selectAll("circle.node")
         .data(data.nodes)
         .enter()
         .append("circle")
         .attr("class", function (d) { return "node type" + d.type })
         .attr("r", function (d) {
            return d.r
         })
         .call(force.drag)
      console.warn(node);
      d3.select("body").select("svg")
         .on('click', function (d) {
            //console.error(d3.event.target);
            if (d3.event.target == "svg" && expand) {
               data.links = [];
               console.warn(data.links);
               vis.selectAll("line").remove()
               force.nodes(data.nodes).links(data.links).start();
               expand = false;
               return;
            }
         })
      var text = d3.select(".texts")
         .selectAll("text")
         .data(data.nodes)
         .enter()
         .append("text")
         .attr("class", function (d) { return "nodetext title_" + d.name })
         .attr("dx", function (d) { return d.x + d.r; })
         .attr("dy", function (d) { return d.y + d.r; })
         .style("font-size", "10px")
         // .attr("text-anchor", "middle")
         .style("fill", "black")
         .text(function (d) {
            if (d.parent) {
               return d.name
            }
            else {
               return ""
            }
         });
      node.on("mouseover", function (d) {
         //d3.select(this).style("fill", "black")
         // link.style('stroke-width', function (l) {
         //    if (d === l.source || d === l.target)
         //       return 2;
         //    else
         //       return 1;
         // });
         document.querySelector('img').setAttribute('src', d.img);
      })
      node.on('click', function (d) {
         //eliminar child - Alquiler

         if (expand && d.parent == true) {
            data.links = [];
            vis.selectAll("line").remove()
            force.nodes(data.nodes).links(data.links).start();
            console.log("eliminar child - Alquiler")
            expand = false;
         }
         else if (expandChild && typeof d.links != "undefined" && d.parentChild) {
            document.querySelectorAll(`[data-parent='${d.index}']`)
               .forEach(element => {
                  element.remove();
               });
            data.links = data.links.filter(item => {
               return item.source.index != d.index
            })

            vis.selectAll("line").remove()
            force.nodes(data.nodes).links(data.links).start();
            link = d3.select('.lines').selectAll("line.link")
               .data(data.links)//data
               .enter().append("svg:line")
               .attr("class", function (d) { return "link" + d.value + ""; })
               .attr("x1", function (d) {
                  console.log(d.source.x);
                  return d.source.x;
               })
               .attr("y1", function (d) { return d.source.y; })
               .attr("x2", function (d) { return d.target.x; })
               .attr("y2", function (d) { return d.target.y; })
            d3.select(this).select('text')
               .transition()
               .duration(300)
               .text(function (d) {
                  if (d.parent) {
                     return d.name
                  }
                  else {
                     return ""
                  }
               })
               .style("font-size", "10px")
            d3.select(this).select('circle')
               .transition()
               .duration(200)
               .attr("r", function (d) {
                  return d.r;
               });
            d3.select(this).select('text')
               .transition()
               .duration(300)
               .style("font-size", "10px")
               .text(function (d) {
                  return d.name
               }
               );
            console.log("Cerrar _ Childs")
            expandChild = false;
         }
         else if (d.parentChild == true && typeof d.links != "undefined" && !expandChild) {
            d.links.forEach(element => {
               data.links.push(element);
            });
            force.links(data.links).start();
            vis.selectAll("line").remove()
            force.nodes(data.nodes).links(data.links).start();
            link = d3.select('.lines').selectAll("line.link")
               .data(data.links)//data
               .enter().append("svg:line")
               .attr("data-parent", function (d) {
                  return d.source.index;
               })
               .attr("class", function (d) { return "link" + d.value + ""; })
               .attr("x1", function (d) {
                  return d.source.x;
               })
               .attr("y1", function (d) { return d.source.y; })
               .attr("x2", function (d) { return d.target.x; })
               .attr("y2", function (d) { return d.target.y; })

            d3.select(this)
               .select("circle")
               .transition()
               .duration(200)
               .attr("r", function (d) {
                  return d.r * 1.5;
               });
            // d3.select(this).select('text')
            //    .transition()
            //    .duration(300)
            //    .style("font-size", "15px")
            //    .text(function (d) {
            //       return d.name
            //    }
            //    );
            console.log("expand _ Childs")
            expandChild = true;
         }

         else if (!expand && d.parent) {
            d.links.forEach(element => {
               data.links.push(element);
            });
            force.links(data.links).start();
            // console.warn(d.links);
            vis.selectAll("line").remove()
            force.nodes(data.nodes).links(data.links).start();
            link = d3.select('.lines').selectAll("line.link")
               .data(data.links)//data
               .enter().append("svg:line")
               .attr("class", function (d) { return "link" + d.value + ""; })
               .attr("x1", function (d) {
                  // console.log(d.source.x);
                  return d.source.x;
               })
               .attr("y1", function (d) { return d.source.y; })
               .attr("x2", function (d) { return d.target.x; })
               .attr("y2", function (d) { return d.target.y; })
            console.log("Expand _ Parent")
            expand = true;
         }
         console.log("expand", expand);
         console.log("expandChild", expandChild);
      })
      node.on("mouseout", function (d) {
         //link.style('stroke-width', 2);




      });
      force.on("tick", function (d) {
         // console.log(d)
         link.attr("x1", function (d) { return d.source.x; })
            .attr("y1", function (d) { return d.source.y; })
            .attr("x2", function (d) { return d.target.x; })
            .attr("y2", function (d) { return d.target.y; });
         node.attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });

         text
            .transition()
            .duration(300)
            .style("font-size", "10px")
            .text(function (d) {
               if (d.parent || expand) {
                  return d.name
               } else if (d.parentChild && expand) {
                  return d.name
               } else if (expandChild) {
                  return d.name
               } else {
                  return ""
               }
            }
            )

         text
            .attr("dx", function (d) { return d.x + d.r; })
            .attr("dy", function (d) { return d.y - d.r; });
         // node.attr("dx", fu;
      });
      //});
      btnRestart.addEventListener('click', function () {
         data.links = [];
         console.warn(data.links);
         vis.selectAll("line").remove()
         force.nodes(data.nodes).links(data.links).start();
         expand = false;
      })
   </script>
</body>

</html>